<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluesky Feed (Notion Embed)</title>
  <style>
    :root{
      --bg:#fff; --fg:#111; --muted:#666; --card:#fafafa; --link:#0b57d0; --border:#e5e7eb;
    }
    [data-theme="dark"]{
      --bg:#0b0b0b; --fg:#eaeaea; --muted:#a2a2a2; --card:#151515; --link:#8ab4f8; --border:#262626;
    }
    html,body{
      margin:0;padding:0;
      background:var(--bg);color:var(--fg);
      font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Sans", "Noto Sans JP", sans-serif;
    }
    .wrap{
      max-width:100%;
      margin:0 auto;
      padding:16px;
      box-sizing:border-box;
    }
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0;}
    .row{display:flex;gap:10px}
    .avatar{width:40px;height:40px;border-radius:50%;flex:0 0 auto;border:1px solid var(--border);background:#ddd}
    .meta{font-size:12px;color:var(--muted)}
    .displayName{font-weight:600;color:var(--fg)}
    .handle{color:var(--muted)}
    .text{white-space:pre-wrap;word-wrap:break-word;margin:6px 0 8px}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    .imgs{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:6px}
    .imgs img{width:100%;height:auto;border-radius:10px;border:1px solid var(--border)}
    .ext{display:flex;gap:10px;border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:6px;background:transparent}
    .ext img{width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}
    .reason{font-size:12px;color:var(--muted);margin-bottom:4px}
    .footer{margin-top:6px;color:var(--muted);font-size:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .spinner{width:22px;height:22px;border:3px solid var(--border);border-top-color:var(--link);border-radius:50%;animation:spin 1s linear infinite;margin-right:6px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .err{color:#d32f2f;background:#fdecea;border:1px solid #f5c6c6;padding:10px;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <!-- スピナーとコントロールは非表示で置いておく -->
    <div style="display:none">
      <div class="spinner" id="spin"></div>
      <div id="controls"></div>
    </div>
    <div id="feed"></div>
  </div>

<script>
(async () => {
  const params = new URLSearchParams(location.search);
  const actor = params.get('actor') || 'bsky.app';
  const limit = Math.min(parseInt(params.get('limit') || '20', 10), 100);
  const theme = (params.get('theme') || '').toLowerCase() === 'dark' ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', theme);

  const feedEl = document.getElementById('feed');
  const spin = document.getElementById('spin');
  const controls = document.getElementById('controls');
  if (controls) {
    controls.innerHTML = `actor=<b>${actor}</b> · limit=${limit} · theme=${theme}`;
  }

  const endpoint = `https://public.api.bsky.app/xrpc/app.bsky.feed.getAuthorFeed?actor=${encodeURIComponent(actor)}&limit=${limit}`;

  try {
    const res = await fetch(endpoint, { headers: { 'accept': 'application/json' }});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    if (spin) spin.style.display = 'none';

    if (!data.feed || !data.feed.length) {
      feedEl.innerHTML = `<div class="err">投稿が見つかりませんでした。</div>`;
      return;
    }

    for (const item of data.feed) {
      const post = item.post || {};
      const author = post.author || {};
      const rec = post.record || {};
      const reason = item.reason && item.reason.$type ? (item.reason.$type.includes('repost') ? 'Repost' : '') : '';
      const href = `https://bsky.app/profile/${encodeURIComponent(author.did || author.handle)}/post/${post.uri?.split('/').pop() || ''}`;

      const card = document.createElement('div');
      card.className = 'card';

      card.innerHTML = `
        ${reason ? `<div class="reason">↻ ${reason}</div>` : ``}
        <div class="row">
          <img class="avatar" src="${escapeAttr(author.avatar || '')}" alt="" />
          <div style="flex:1">
            <div><span class="displayName">${escapeHtml(author.displayName || '')}</span>
              <span class="handle">@${escapeHtml(author.handle || author.did || '')}</span></div>
            <div class="text">${linkifyText( rec.text || '', rec.facets )}</div>
            ${renderImages(post.embed)}
            ${renderExternal(post.embed)}
            <div class="footer">
              <a href="${href}" target="_blank" rel="noopener">Open in Bluesky</a>
              <span>·</span>
              <span title="${new Date(post.indexedAt).toISOString()}">${timeago(post.indexedAt)}</span>
            </div>
          </div>
        </div>
      `;
      feedEl.appendChild(card);
    }
  } catch (e) {
    if (spin) spin.style.display = 'none';
    feedEl.innerHTML = `<div class="err">読み込みに失敗しました：${escapeHtml(String(e.message || e))}</div>`;
  }

  // 以下は元コードと同じヘルパー関数群（省略せずにそのまま）
  function timeago(dt){ /* ... */ }
  function renderImages(embed){ /* ... */ }
  function renderExternal(embed){ /* ... */ }
  function linkifyText(text, facets){ /* ... */ }
  function byteToChar(str, byteIndex){ /* ... */ }
  function escapeHtml(s){ return (s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function escapeAttr(s){ return String(s??'').replace(/"/g,'&quot;'); }
  function escapeReg(s){ return new RegExp(s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'); }
})();
</script>
</body>
</html>
